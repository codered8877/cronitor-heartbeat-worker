services:
  - type: web
    name: aplus-pipeline
    env: node
    plan: starter
    runtime: node
    region: virginia
    buildCommand: "npm ci"
    startCommand: "node index.js"
    autoDeploy: true
    healthCheckPath: /health
    envVars:
      # ---- REQUIRED (single DB config) ----
      - key: DATABASE_URL
        value: "postgresql://btc_logger:pAgX7BuJRM4RYQl3Kq3wBjWwGggXhsOs@dpg-d300nsvdiees738rlnog-a.virginia-postgres.render.com:5432/btc_scalp_logs?ssl=true"

      # ---- REQUIRED (app-level) ----
      - key: PRODUCT_ID
        value: "BTC-USD"

      # ---- PUBLIC base URL ----
      - key: PUBLIC_BASE_URL
        value: "https://aplus-pipeline.onrender.com"

      # ---- SECURITY TOKENS ----
      - key: ADMIN_TOKEN
        value: "a57f1b8d9c4e4f62b2c1e983e94d3a7f"
      - key: BACKUP_TOKEN
        value: "7c13f3aa50db4f3b82afc8a68d29c987"
      - key: RETENTION_TOKEN
        value: "3ff82c4e1b944d2bb99b9b7c56a8e123"
      - key: TV_API_KEY
        value: ""
      - key: ZAP_API_KEY
        value: ""
      - key: ZAP_B_URL
        value: "https://hooks.zapier.com/hooks/catch/24548615/um2ks46/"
      - key: CRONITOR_URL
        value: "https://cronitor.link/p/73e27affa70a46329181849e9d89e253/DwcCTj"

      # ---- PERFORMANCE / TIMING ----
      - key: DOM_POLL_MS
        value: "9000"
      - key: CVD_EMA_LEN
        value: "34"
      - key: MAX_DOM_AGE_MS
        value: "45000"
      - key: MAX_CVD_AGE_MS
        value: "75000"

# ==============================
# CRON JOBS (all <30s)
# ==============================
cronJobs:
  # 1️⃣ Health ping (every 5 min)
  - name: aplus-health
    schedule: "*/5 * * * *"
    httpMethod: GET
    url: "$PUBLIC_BASE_URL/health"

  # 2️⃣ Retention cleanup (nightly)
  - name: aplus-nightly-prune
    schedule: "0 5 * * *"
    httpMethod: GET
    url: "$PUBLIC_BASE_URL/retention?token=3ff82c4e1b944d2bb99b9b7c56a8e123"
    headers:
      - key: X-Auth-Token
        value: "3ff82c4e1b944d2bb99b9b7c56a8e123"

  # 3️⃣ Backup (nightly gzip)
  - name: aplus-backup
    schedule: "15 5 * * *"
    httpMethod: GET
    url: "$PUBLIC_BASE_URL/backup?token=7c13f3aa50db4f3b82afc8a68d29c987&days=1"
    headers:
      - key: X-Auth-Token
        value: "7c13f3aa50db4f3b82afc8a68d29c987"

  # 4️⃣ Backup check (verify backup)
  - name: aplus-backup-check
    schedule: "20 5 * * *"
    httpMethod: GET
    url: "$PUBLIC_BASE_URL/backup/check?token=7c13f3aa50db4f3b82afc8a68d29c987"
    headers:
      - key: X-Auth-Token
        value: "7c13f3aa50db4f3b82afc8a68d29c987"

  # 5️⃣ Integrity snapshot (env self-test)
  - name: aplus-integrity
    schedule: "25 5 * * *"
    httpMethod: GET
    url: "$PUBLIC_BASE_URL/env?token=3ff82c4e1b944d2bb99b9b7c56a8e123"
